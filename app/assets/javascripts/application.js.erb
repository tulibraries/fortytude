// This is a manifest file that'll be compiled into application.js, which will include all the files
// listed below.
//
// Any JavaScript/Coffee file within this directory, lib/assets/javascripts, or any plugin's
// vendor/assets/javascripts directory can be referenced here using a relative path.
//
// It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the
// compiled file. JavaScript code in this file should be added after the last require_* statement.
//
// Read Sprockets README (https://github.com/rails/sprockets#sprockets-directives) for details
// about supported directives.
//
//= require rails-ujs
//= require activestorage
//= require jquery
//= require popper
//= require bootstrap-sprockets
//= require jquery_ujs
//= require tinymce-jquery
//= require turbolinks
//= require trix
//= require cable.js
//= require jumble.js
//= require listeners.js
//= require select_all.js

$(document).ready(function() {  
  $('.decorative').each(function() {
    $(this).attr('alt', "");
  });

  $('#slide-image').hover(function() {
    $('#slide-next').css("opacity", .5);
    $('#slide-previous').css("opacity", .5);
  },
  function() {
    $('#slide-next').css("opacity", 0);
    $('#slide-previous').css("opacity", 0);
  });

  $('.icon-toggler').on("click", function() { 
    if (this.id == "mobile-menu-button") {
      document.getElementById("sub-toggler-icon").classList.toggle("change");
    }
    else if (this.id == "menu-button") {
      document.getElementById("navbar-toggler-icon").classList.toggle("change");
    }
    else if (this.id == "mobile-search-button") {
      document.getElementById("search-toggler-icon").classList.toggle("change");
    }
  });

  $('#mobile-menu-image-button').on("click", function() {  
    x = document.getElementById("icon_filter").src;
    if (x.includes("icon_x")) {
      document.getElementById("icon_filter").src = "<%= asset_path('icon_filter_red.png') %>";
    }
    else if (x.includes("icon_filter")) {
      document.getElementById("icon_filter").src = "<%= asset_path('icon_x_red.png') %>" ;
    }
  });
  var HOST = "https://d13txem1unpe48.cloudfront.net/"

  addEventListener("trix-attachment-add", function(event) {
    if (event.attachment.file) {
      uploadFileAttachment(event.attachment)
    }
  })

  function uploadFileAttachment(attachment) {
    uploadFile(attachment.file, setProgress, setAttributes)

    function setProgress(progress) {
      attachment.setUploadProgress(progress)
    }

    function setAttributes(attributes) {
      attachment.setAttributes(attributes)
    }
  }

  function uploadFile(file, progressCallback, successCallback) {
    var key = createStorageKey(file)
    var formData = createFormData(key, file)
    var xhr = new XMLHttpRequest()

    xhr.open("POST", HOST, true)

    xhr.upload.addEventListener("progress", function(event) {
      var progress = event.loaded / event.total * 100
      progressCallback(progress)
    })

    xhr.addEventListener("load", function(event) {
      if (xhr.status == 204) {
        var attributes = {
          url: HOST + key,
          href: HOST + key + "?content-disposition=attachment"
        }
        successCallback(attributes)
      }
    })

    xhr.send(formData)
  }

  function createStorageKey(file) {
    var date = new Date()
    var day = date.toISOString().slice(0,10)
    var name = date.getTime() + "-" + file.name
    return [ "tmp", day, name ].join("/")
  }

  function createFormData(key, file) {
    var data = new FormData()
    data.append("key", key)
    data.append("Content-Type", file.type)
    data.append("file", file)
    return data
  }
});
